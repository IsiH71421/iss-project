<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>ISS Screen Control</title>
  <link rel="stylesheet" href="../assets/style.css" />
  <script src="https://cpee.org/js_libs/jquery.min.js"></script>
  <script>
    function sendCommand(command) {
      $.ajax({
        type: "PUT",
        url: window.name,
        contentType: "application/json",
        data: JSON.stringify({ command: command }),
        success: function () {
          alert("âœ… Command sent: " + command);
        },
        error: function () {
          alert("âŒ Failed to send command");
        }
      });
    }
  </script>
</head>

<body>
  <h1>ISS</h1>

  <div id="countdown-container">
    <h2>Next ISS Pass Over Garching</h2>
    <div id="countdown">Loading countdown...</div>
    <div id="final-message"></div>
  </div>

  <div class="control-buttons">
    <div class="qr-code-option">
      <span class="emoji">ğŸ”­</span> Show Seven Day Forecast
      <img src="../assets/qr_iss_passes.png" alt="Forecast QR" class="qr-code">
    </div>

    <div class="qr-code-option">
      <span class="emoji">ğŸŒ</span> Show ISS Location
      <img src="../assets/qr_iss_position.png" alt="Location QR" class="qr-code">
    </div>

    <div class="qr-code-option">
      <span class="emoji">ğŸ¤“</span> Show ISS Crew
      <img src="../assets/qr_people.png" alt="Crew QR" class="qr-code">
    </div>

    <div class="qr-code-option">
      <span class="emoji">ğŸ“¡</span> Show NASA Picture of the Day
      <img src="../assets/qr_picture.png" alt="Picture QR" class="qr-code">
    </div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const startParam = urlParams.get('start');
    const endParam = urlParams.get('end');

    const countdownEl = document.getElementById('countdown');
    const finalMessageEl = document.getElementById('final-message');

    const startTimestamp = startParam ? parseInt(startParam) * 1000 : null;
    const endTimestamp = endParam ? parseInt(endParam) * 1000 : null;

    function formatTime(secondsTotal) {
      const days = Math.floor(secondsTotal / (3600 * 24));
      const hours = Math.floor((secondsTotal % (3600 * 24)) / 3600);
      const mins = Math.floor((secondsTotal % 3600) / 60);
      const secs = secondsTotal % 60;

      let parts = [];
      if (days > 0) parts.push(`${days} day${days !== 1 ? 's' : ''}`);
      if (hours > 0) parts.push(`${hours} hour${hours !== 1 ? 's' : ''}`);
      if (mins > 0) parts.push(`${mins} minute${mins !== 1 ? 's' : ''}`);
      parts.push(`${secs} second${secs !== 1 ? 's' : ''}`);

      if (parts.length === 1) return parts[0];
      if (parts.length === 2) return parts[0] + " and " + parts[1];
      return parts.slice(0, -1).join(", ") + ", and " + parts[parts.length - 1];
    }

    function noValidPrediction() {
      countdownEl.textContent = "No prediction data available";
      finalMessageEl.textContent = "";
    }

    if (!startTimestamp || !endTimestamp || isNaN(startTimestamp) || isNaN(endTimestamp)) {
      noValidPrediction();
    } else {
      const now = Date.now();

      if (startTimestamp < now && endTimestamp < now) {
        noValidPrediction();
      } else {
        const durationSeconds = Math.floor((endTimestamp - startTimestamp) / 1000);

        function updateCountdown() {
          const now = Date.now();

          if (now < startTimestamp) {
            const diff = Math.floor((startTimestamp - now) / 1000);
            countdownEl.textContent = `Next pass in ${formatTime(diff)} (Duration: ${formatTime(durationSeconds)})`;

            if (diff <= 60) {
              countdownEl.classList.add("alert");
              finalMessageEl.textContent = "ğŸš€ ISS is coming NOW!";
            } else {
              countdownEl.classList.remove("alert");
              finalMessageEl.textContent = "";
            }
          } else if (now >= startTimestamp && now < endTimestamp) {
            const remaining = Math.floor((endTimestamp - now) / 1000);
            countdownEl.textContent = `ğŸ‘€ ISS is visible! Time left: ${formatTime(remaining)}`;
            countdownEl.classList.add("alert");
            finalMessageEl.textContent = "Don't miss it!";
          } else {
            countdownEl.textContent = "";
            countdownEl.classList.remove("alert");
            finalMessageEl.textContent = "The ISS is gone. Did you take some nice pictures?";
          }
        }

        updateCountdown();
        setInterval(updateCountdown, 1000);
      }
    }
  </script>
</body>

</html>
