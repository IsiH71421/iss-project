<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>ISS Crew</title>
  <link rel="stylesheet" href="../assets/css/style.css" />
</head>

<body class="crew-page">
  <div class="main-layout">
    <div class="content">
      <h1 id="main-title"></h1>

      <div id="crew"></div>
    </div>

    <div class="qr-code-option-container">
      <div class="qr-code-option">
        <span class="emoji">â¬…</span>
        <span class="text-content">Back to Countdown</span>
        <img src="../assets/qr_index.png" alt="Back QR" class="qr-code">
      </div>
    </div>
  </div>

  <script>
    function getExpeditionDataFromURL() {
      const params = new URLSearchParams(window.location.search);
      const dataParam = params.get('params');

      if (!dataParam) return null;

      try {
        return JSON.parse(dataParam);
      } catch (e) {
        console.error("Error parsing expedition params:", e);
        return null;
      }
    }

    function formatDate(unixTimestamp) {
      const date = new Date(unixTimestamp * 1000);
      return date.toLocaleDateString('en-GB', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    }

    function renderExpeditionInfo(data) {
      const titleEl = document.getElementById('main-title');
      const expeditionNumber = data.expedition_number ?? 'Unknown';
      const startDate = data.start_date ? formatDate(data.start_date) : 'N/A';
      const endDate = data.end_date ? formatDate(data.end_date) : 'N/A';

      titleEl.textContent = `ISS Expedition ${expeditionNumber} - ${startDate} to ${endDate}`;
    }

    function renderCrewList(crewArray) {
      const container = document.getElementById('crew');

      // Define spacecraft categories
      const spacecraftCategories = {
        'Crew Dragon': {
          title: 'Crew Dragon (NASA / SpaceX) - Long-duration crew',
          members: []
        },
        'Soyuz MS': {
          title: 'Soyuz MS (Roskosmos) - Long-duration crew',
          members: []
        },
        'Axiom': {
          title: 'Axiom Missions (Axiom & SpaceX) - Commercial short-term visits',
          members: []
        },
        'Starliner': {
          title: 'Boeing Starliner (NASA / Boeing) - Long-duration missions',
          members: []
        },
        'Others': {
          title: 'Others - Unclassified or special missions',
          members: []
        }
      };

      // Group crew members by spacecraft
      crewArray.forEach(person => {
        const spacecraft = person.spacecraft;
        if (spacecraft.includes('Crew-10 Dragon')) {
          spacecraftCategories['Crew Dragon'].members.push(person);
        } else if (spacecraft.includes('Soyuz') || spacecraft.includes('MS')) {
          spacecraftCategories['Soyuz MS'].members.push(person);
        } else if (spacecraft.includes('Axiom')) {
          spacecraftCategories['Axiom'].members.push(person);
        } else if (spacecraft.includes('Starliner')) {
          spacecraftCategories['Starliner'].members.push(person);
        } else {
          // Default to Others if unknown
          spacecraftCategories['Others'].members.push(person);
        }
      });

      // Create blocks for each category that has members
      Object.values(spacecraftCategories).forEach(category => {
        if (category.members.length > 0) {
          const block = document.createElement('div');
          block.className = 'spacecraft-block';

          const title = document.createElement('h2');
          title.innerHTML = category.title;
          title.className = 'spacecraft-title';
          block.appendChild(title);

          const membersList = document.createElement('div');
          membersList.className = 'crew-members';

          // Use two columns if there are more than 4 members
          if (category.members.length > 4) {
            membersList.classList.add('two-columns');
            block.classList.add('has-two-columns');
          }

          category.members.forEach(person => {
            const memberDiv = document.createElement('div');
            memberDiv.className = 'crew-member';
            memberDiv.innerHTML = `
              <strong>${person.name}</strong><br>
              <span>Country: ${person.country}</span><br>
              <span>Position: ${person.position}</span>
            `;
            membersList.appendChild(memberDiv);
          });

          block.appendChild(membersList);
          container.appendChild(block);
        }
      });
    }

    const expeditionData = getExpeditionDataFromURL();
    if (expeditionData) {
      renderExpeditionInfo(expeditionData);
      if (Array.isArray(expeditionData.crew)) {
        renderCrewList(expeditionData.crew);
      }
    }
  </script>

</body>

</html>
