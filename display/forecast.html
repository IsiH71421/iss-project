<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>ISS Passes in the Next 7 Days</title>
  <link rel="stylesheet" href="../assets/style.css" />
</head>

<body>
  <h1>ISS Passes in the Next 7 Days</h1>
  <div id="passes"></div>

  <script>
    function formatDuration(seconds) {
      const days = Math.floor(seconds / (3600 * 24));
      const hours = Math.floor((seconds % (3600 * 24)) / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const secs = seconds % 60;

      let parts = [];
      if (days > 0) parts.push(days + ' day' + (days > 1 ? 's' : ''));
      if (days > 0 || hours > 0) parts.push(hours + ' hour' + (hours !== 1 ? 's' : ''));
      if (days > 0 || hours > 0 || minutes > 0) parts.push(minutes + ' minute' + (minutes !== 1 ? 's' : ''));
      parts.push(secs + ' second' + (secs !== 1 ? 's' : ''));

      if (parts.length === 1) return parts[0];
      if (parts.length === 2) return parts[0] + ' and ' + parts[1];
      return parts.slice(0, -1).join(', ') + ' and ' + parts[parts.length - 1];
    }

    function updateCountdowns() {
      const now = Date.now();
      document.querySelectorAll('.pass').forEach(div => {
        const start = parseInt(div.dataset.start) * 1000;
        const end = parseInt(div.dataset.end) * 1000;

        let text;
        if (now < start) {
          const diff = Math.floor((start - now) / 1000);
          text = 'Next pass in ' + formatDuration(diff) + '. <br>ISS will be visible for ' + formatDuration(Math.floor((end - start) / 1000)) + '.';
        } else if (now >= start && now <= end) {
          const diff = Math.floor((end - now) / 1000);
          text = 'Pass in progress, ends in ' + formatDuration(diff) + '.';
        } else {
          text = 'Pass finished. Did you take cool pictures?';
        }
        div.querySelector('.countdown').innerHTML = text;
      });
    }

    const params = new URLSearchParams(window.location.search);
    const timestampsParam = params.get('timestamps');

    let passes = [];

    if (timestampsParam) {
      try {
        const timestamps = JSON.parse(timestampsParam);

        for (let i = 0; i < timestamps.length; i += 2) {
          passes.push({
            start: parseInt(timestamps[i], 10),
            end: parseInt(timestamps[i + 1], 10)
          });
        }
      } catch (e) {
        console.error("Invalid timestamps parameter:", e);
      }
    }

    const container = document.getElementById('passes');

    if (passes.length === 0) {
      container.textContent = 'No passes found in the next 7 days.';
    } else {
      passes.forEach(p => {
        const div = document.createElement('div');
        div.className = 'pass';
        div.dataset.start = p.start;
        div.dataset.end = p.end;

        const startDate = new Date(p.start * 1000);
        const endDate = new Date(p.end * 1000);

        div.innerHTML = `
        <div>Start: ${startDate.toLocaleString('en-US')}</div>
        <div>End: ${endDate.toLocaleString('en-US')}</div>
        <div class="countdown">Loading countdown...</div>
      `;

        container.appendChild(div);
      });
    }

    updateCountdowns();
    setInterval(updateCountdowns, 1000);
  </script>

  <div class="qr-code-option">
    <span class="emoji">â¬…</span> Back to Countdown
    <img src="../assets/qr_index.png" alt="Back QR" class="qr-code">
  </div>

</body>

</html>
