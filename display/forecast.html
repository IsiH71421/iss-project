<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>ISS Passes in the Next 7 Days</title>
  <link rel="stylesheet" href="../assets/css/style.css" />
  <script src="../assets/js/functions.js"></script>
</head>

<body>
  <h1>ISS Passes in the Next 7 Days</h1>
  <div id="passes"></div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const timestampsParam = params.get('timestamps');

    let passes = [];

    if (timestampsParam) {
      try {
        const timestamps = JSON.parse(timestampsParam);
        for (let i = 0; i < timestamps.length; i += 2) {
          passes.push({
            start: parseInt(timestamps[i], 10),
            end: parseInt(timestamps[i + 1], 10)
          });
        }
      } catch (e) {
        console.error("Invalid timestamps parameter:", e);
      }
    }

    const container = document.getElementById('passes');

    if (passes.length === 0) {
      container.textContent = 'No passes found in the next 7 days.';
    } else {
      passes.forEach((p, index) => {
        const div = document.createElement('div');
        div.className = 'pass';
        div.dataset.start = p.start;
        div.dataset.end = p.end;

        const startDate = new Date(p.start * 1000);
        const endDate = new Date(p.end * 1000);

        div.innerHTML = `
        <h2>Pass ${index + 1}</h2>
          <div>Start: ${startDate.toLocaleString('en-US')}</div>
          <div>End: ${endDate.toLocaleString('en-US')}</div>
          <div class="countdown">Loading countdown...</div>
        `;

        container.appendChild(div);
      });
    }

    function updateCountdowns() {
      const now = Date.now();
      document.querySelectorAll('.pass').forEach(div => {
        const start = parseInt(div.dataset.start) * 1000;
        const end = parseInt(div.dataset.end) * 1000;

        let text;
        if (now < start) {
          const diff = Math.floor((start - now) / 1000);
          text = `Time left: ${formatTimeNoSeconds(diff)}.<br>Visibility Duration: ${formatTime(Math.floor((end - start) / 1000))}.`;
        } else if (now >= start && now <= end) {
          const diff = Math.floor((end - now) / 1000);
          text = `Pass in progress, ends in ${formatTimeNoSeconds(diff)}.`;
        } else {
          text = 'Pass finished. Did you take cool pictures?';
        }
        div.querySelector('.countdown').innerHTML = text;
      });
    }

    updateCountdowns();
    setInterval(updateCountdowns, 1000);
  </script>

  <div class="qr-code-option">
    <span class="emoji">â¬…</span> Back to Countdown
    <img src="../assets/qr_index.png" alt="Back QR" class="qr-code">
  </div>
</body>

</html>
